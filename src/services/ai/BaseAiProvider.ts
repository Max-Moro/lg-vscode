/**
 * Base AI Provider
 * 
 * –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Å –æ–±—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
 */

import * as vscode from "vscode";
import { logInfo, logDebug, logTrace } from "../../logging/log";
import type { 
  IAiProvider, 
  AiProvider, 
  AiContent, 
  AiProviderOptions, 
  AiProviderInfo,
  ContentType 
} from "./types";

export abstract class BaseAiProvider implements IAiProvider {
  abstract readonly id: AiProvider;
  abstract readonly info: AiProviderInfo;

  /**
   * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö)
   */
  abstract isAvailable(): Promise<boolean>;

  /**
   * –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞—Ö)
   */
  abstract sendContent(content: AiContent, options?: AiProviderOptions): Promise<void>;

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
   */
  getContentRecommendations(content: AiContent): { warnings: string[]; suggestions: string[] } {
    const warnings: string[] = [];
    const suggestions: string[] = [];
    
    // –û–±—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞
    const maxRecommended = this.info.capabilities.recommendedMaxLength;
    if (maxRecommended && content.content.length > maxRecommended) {
      warnings.push(`Content length (${this.formatSize(content.content.length)}) exceeds recommended limit (${this.formatSize(maxRecommended)})`);
      suggestions.push('Consider breaking down the content into smaller parts');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (content.type === 'context' && content.metadata.fileCount && content.metadata.fileCount > 50) {
      warnings.push(`Context includes ${content.metadata.fileCount} files, which might be too many for effective processing`);
      suggestions.push('Consider using more specific filters to reduce the number of files');
    }
    
    if (content.type === 'listing' && content.content.length > 100000) {
      suggestions.push('Large listings work better when focused on specific modules or components');
    }
    
    return { warnings, suggestions };
  }

  /**
   * –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   */
  protected createContentPrefix(content: AiContent): string {
    const { type, metadata } = content;
    const icon = this.getContentTypeIcon(type);
    
    switch (type) {
      case 'context':
        return `# ${icon} LG Context: ${metadata.name}\n\n` +
               `Generated by Listing Generator from template \`${metadata.name}\`.\n` +
               `This context was carefully prepared to fit within model limits.\n` +
               `Size: ${this.formatSize(metadata.size)}${metadata.fileCount ? `, Files: ${metadata.fileCount}` : ''}`;
               
      case 'listing':
        const mode = metadata.mode || 'all';
        return `# ${icon} LG Listing: ${metadata.name} (${mode})\n\n` +
               `Generated by Listing Generator from section \`${metadata.name}\` in \`${mode}\` mode.\n` +
               `This listing includes only relevant files that passed the configured filters.\n` +
               `Size: ${this.formatSize(metadata.size)}${metadata.fileCount ? `, Files: ${metadata.fileCount}` : ''}`;
               
      case 'generic':
      default:
        return `# ${icon} LG Content: ${metadata.name}\n\n` +
               `Generated by Listing Generator.\n` +
               `Size: ${this.formatSize(metadata.size)}`;
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   */
  private getContentTypeIcon(type: ContentType): string {
    switch (type) {
      case 'context': return 'üéØ';
      case 'listing': return 'üìã';
      case 'generic': return 'üìÑ';
      default: return 'üìÑ';
    }
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
   */
  protected formatSize(length: number): string {
    if (length < 1000) {
      return `${length} chars`;
    } else if (length < 1000000) {
      return `${(length / 1000).toFixed(1)}K chars`;
    } else {
      return `${(length / 1000000).toFixed(1)}M chars`;
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ü–∏–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ VS Code
   */
  protected getConfigOptions(): AiProviderOptions {
    const cfg = vscode.workspace.getConfiguration();
    
    return {
      addPrefix: cfg.get<boolean>("lg.ai.addPrefix", false),
      showDetailedNotifications: cfg.get<boolean>("lg.ai.showDetailedNotifications", false),
      autoOpenPanel: cfg.get<boolean>("lg.ai.autoOpenPanel", true),
      maxContentLength: cfg.get<number>("lg.ai.maxContentLength", 1000000),
    };
  }

  /**
   * –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–ø—Ü–∏–π (–ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)
   */
  protected mergeOptions(configOptions: AiProviderOptions, passedOptions?: AiProviderOptions): AiProviderOptions {
    return {
      ...configOptions,
      ...(passedOptions || {})
    };
  }

  /**
   * –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
   */
  protected async copyToClipboard(finalContent: string): Promise<void> {
    await vscode.env.clipboard.writeText(finalContent);
    logInfo(`[${this.id}] Content copied to clipboard, length: ${finalContent.length} chars`);
    logDebug(`[${this.id}] Content preview: ${finalContent.slice(0, 200)}...`);
  }

  /**
   * –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   */
  protected async showNotification(content: AiContent, options: AiProviderOptions, success: boolean = true): Promise<void> {
    const size = this.formatSize(content.content.length);
    
    if (options.showDetailedNotifications) {
      const instructions = this.getDetailedInstructions();
      const message = success 
        ? `‚úÖ LG content copied to clipboard (${size})\n\nüìã Next steps:\n${instructions}`
        : `‚ùå Failed to send content to AI`;
        
      await vscode.window.showInformationMessage(
        message,
        { modal: false },
        "üìö Got it"
      );
    } else {
      const message = success
        ? `üìã Content copied to clipboard (${size})`
        : `‚ùå Failed to send to ${this.info.name}`;
        
      if (success) {
        vscode.window.showInformationMessage(message);
      } else {
        vscode.window.showErrorMessage(message);
      }
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  protected abstract getDetailedInstructions(): string;

  /**
   * –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è AI –ø–∞–Ω–µ–ª–∏
   */
  protected abstract tryAutoOpenPanel(): Promise<boolean>;


}

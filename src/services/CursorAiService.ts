/**
 * CursorAiService - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Cursor AI Pane
 * 
 * –ü–æ—Å–∫–æ–ª—å–∫—É Cursor –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ AI Pane,
 * –∏—Å–ø–æ–ª—å–∑—É–µ–º clipboard + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –Ω–∞–∏–±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã–π workaround.
 * 
 * –í –±—É–¥—É—â–µ–º, –µ—Å–ª–∏ Cursor –¥–æ–±–∞–≤–∏—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ API, –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.
 */
import * as vscode from "vscode";
import { logInfo, logDebug } from "../logging/log";

export interface CursorAiOptions {
  /** –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–∫–∞–∑–∞–Ω–∏–µ —á—Ç–æ —ç—Ç–æ –æ—Ç LG) */
  prefix?: string;
  /** –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é */
  showDetailedNotification?: boolean;
}

export class CursorAiService {
  
  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ Cursor AI Pane —á–µ—Ä–µ–∑ clipboard.
   * 
   * @param content - –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
   * @param options - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
   */
  static async sendToAI(content: string, options: CursorAiOptions = {}): Promise<void> {
    const { prefix, showDetailedNotification = true } = options;
    
    try {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
      let finalContent = content;
      if (prefix) {
        finalContent = `${prefix}\n\n${content}`;
      }
      
      // –ö–æ–ø–∏—Ä—É–µ–º –≤ clipboard
      await vscode.env.clipboard.writeText(finalContent);
      
      logInfo(`[CursorAI] Content copied to clipboard, length: ${finalContent.length} chars`);
      logDebug(`[CursorAI] Content preview: ${finalContent.slice(0, 200)}...`);
      
      if (showDetailedNotification) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        const action = await vscode.window.showInformationMessage(
          `‚úÖ LG content copied to clipboard (${this.formatSize(finalContent.length)})\n\n` +
          "üìã Next steps:\n" +
          "1. Open Cursor AI Pane (Ctrl+L or Cmd+L)\n" +
          "2. Paste content (Ctrl+V or Cmd+V)\n" +
          "3. Start your conversation!",
          { modal: false },
          "‚ú® Open Cursor AI",
          "üìö Got it"
        );
        
        if (action === "‚ú® Open Cursor AI") {
          // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å Cursor AI —á–µ—Ä–µ–∑ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
          await this.tryOpenCursorAI();
        }
      } else {
        // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        vscode.window.showInformationMessage(
          `üìã LG content copied! Paste it in Cursor AI (${this.formatSize(finalContent.length)})`
        );
      }
      
    } catch (error: any) {
      const message = `Failed to send content to Cursor AI: ${error?.message || error}`;
      logInfo(`[CursorAI] Error: ${message}`);
      vscode.window.showErrorMessage(message);
      throw error;
    }
  }
  
  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ Cursor AI
   */
  static async sendContext(templateName: string, content: string): Promise<void> {
    const prefix = `# üéØ LG Context: ${templateName}\n\n` +
                  `Generated by Listing Generator from template \`${templateName}\`.\n` +
                  `This context was carefully prepared to fit within model limits.`;
    
    await this.sendToAI(content, { 
      prefix,
      showDetailedNotification: true 
    });
  }
  
  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç–∏–Ω–≥ –≤ Cursor AI
   */
  static async sendListing(sectionName: string, mode: string, content: string): Promise<void> {
    const prefix = `# üìã LG Listing: ${sectionName} (${mode})\n\n` +
                  `Generated by Listing Generator from section \`${sectionName}\` in \`${mode}\` mode.\n` +
                  `This listing includes only relevant files that passed the configured filters.`;
    
    await this.sendToAI(content, { 
      prefix,
      showDetailedNotification: true 
    });
  }
  
  /**
   * –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å Cursor AI Pane —á–µ—Ä–µ–∑ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
   */
  private static async tryOpenCursorAI(): Promise<void> {
    const possibleCommands = [
      'cursor.openAIPane',
      'cursor.showAIChat',
      'cursor.ai.open',
      'workbench.action.chat.open',
      // –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
    ];
    
    for (const command of possibleCommands) {
      try {
        await vscode.commands.executeCommand(command);
        logDebug(`[CursorAI] Successfully executed command: ${command}`);
        return;
      } catch (error) {
        logDebug(`[CursorAI] Command ${command} failed: ${error}`);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
      }
    }
    
    // –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
    vscode.window.showInformationMessage(
      "Please manually open Cursor AI Pane (Ctrl+L or Cmd+L) and paste the content."
    );
  }
  
  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   */
  private static formatSize(length: number): string {
    if (length < 1000) {
      return `${length} chars`;
    } else if (length < 1000000) {
      return `${(length / 1000).toFixed(1)}K chars`;
    } else {
      return `${(length / 1000000).toFixed(1)}M chars`;
    }
  }
}

<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'none';
                   style-src {{cspSource}};
                   font-src {{cspSource}};
                   img-src data:;
                   script-src 'nonce-{{nonce}}';">
    <link rel="stylesheet" href="{{codiconsUri}}">
    <link rel="stylesheet" href="{{lgUiCssUri}}">
    <link rel="stylesheet" href="{{controlCssUri}}">
  </head>
  <body data-vscode-theme-kind="">
    <div class="block">
      <h3><span class="codicon codicon-run"></span>AI Contexts</h3>
      
      <!-- Task Context Field -->
      <div class="row task-context-row">
        <textarea
          id="taskText"
          class="lg-chat-input"
          data-state-key="taskText"
          placeholder="Describe current task"
          rows="1"></textarea>
      </div>
      
      <div class="row">
        <span class="cluster">
          <select id="template" class="lg-select grow" data-state-key="template" title="Контекст (.ctx.md) из lg-cfg/"></select>
          <button class="lg-btn" data-action="sendContextToAI" title="Сгенерировать контекст и отправить в AI">
            <span class="codicon codicon-send"></span><span class="btn-text">Send to AI</span>
          </button>
          <button class="lg-btn" id="btn-context" data-action="generateContext" title="Сгенерировать контекст-промт по шаблону">
            <span class="codicon codicon-file-code"></span><span class="btn-text">Generate Context</span>
          </button>
        </span>
        <span class="cluster">
          <button class="lg-btn lg-btn--primary" data-action="showContextStats" title="Показать суммарную статистику токенов для выбранного контекста">
            <span class="codicon codicon-table"></span><span class="btn-text">Show Context Stats</span>
          </button>
        </span>
      </div>
    </div>

    <div class="block">
      <h3><span class="codicon codicon-settings-gear"></span> Adaptive Settings</h3>
      <div id="mode-sets-container" class="mode-sets-container">
        <!-- Mode sets will be populated here -->
      </div>
      
      <!-- Target Branch selector (shown only when review mode is active) -->
      <div id="target-branch-container" class="target-branch-container" style="display: none;">
        <div class="mode-set">
          <label class="mode-set-label">Target Branch</label>
          <select id="targetBranch" data-state-key="targetBranch" class="lg-select mode-select">
            <option value="">Select target branch...</option>
          </select>
        </div>
      </div>
      
      <div class="row">
        <span class="cluster">
          <button class="lg-btn" id="tags-toggle" data-action="toggleTags" title="Configure tags">
            <span class="codicon codicon-tag"></span><span class="btn-text">Configure Tags</span>
          </button>
        </span>
      </div>
    </div>

    <!-- Tags panel (initially hidden) -->
    <div id="tags-panel" class="tags-panel" style="display: none;">
      <div class="tags-panel-header">
        <h3><span class="codicon codicon-tag"></span> Tags Configuration</h3>
        <button class="lg-btn tags-close" id="tags-close" title="Close tags panel">
          <span class="codicon codicon-close"></span>
        </button>
      </div>
      <div id="tag-sets-container" class="tag-sets-container">
        <!-- Tag sets will be populated here -->
      </div>
    </div>

    <div class="block">
      <h3><span class="codicon codicon-graph"></span> Inspect</h3>
      <div class="row">
        <span class="cluster" title="Секция из lg-cfg/sections.yaml или *.sec.yaml">
          <label>Section:</label>
          <select class="lg-select" id="section" data-state-key="section"></select>
        </span>

      </div>
      <div class="row">
        <span class="cluster">
          <button class="lg-btn" data-action="showIncluded" title="Показать какие файлы проходят фильтры">
            <span class="codicon codicon-list-tree"></span><span class="btn-text">Show Included</span>
          </button>
        </span>
        <span class="cluster">
          <button class="lg-btn" data-action="generateListing" title="Сшить исходники из выбранной секции в единый листинг">
           <span class="codicon codicon-file-code"></span><span class="btn-text">Generate Listing</span>
          </button>
          <button class="lg-btn" data-action="sendListingToAI" title="Сгенерировать листинг и отправить в AI">
            <span class="codicon codicon-send"></span><span class="btn-text">Send to AI</span>
          </button>
        </span>
        <span class="cluster">
          <button class="lg-btn" data-action="showStats" title="Таблица размеров и токенов с долями контекста">
            <span class="codicon codicon-table"></span><span class="btn-text">Show Stats</span>
          </button>
        </span>
      </div>
    </div>

    <div class="block">
      <h3><span class="codicon codicon-symbol-unit"></span> Tokenization Settings</h3>
      
      <!-- Библиотека токенизации -->
      <div class="row">
        <span class="cluster" title="Библиотека токенизации (tiktoken, tokenizers, sentencepiece)">
          <label>Library:</label>
          <select class="lg-select" id="tokenizerLib" data-state-key="tokenizerLib"></select>
        </span>
      </div>
      
      <!-- Энкодер (зависит от библиотеки) -->
      <div class="row">
        <span class="cluster" title="Энкодер или модель токенизации">
          <label>Encoder:</label>
          <span class="lg-autosadgest">
            <input type="text" id="encoder" data-state-key="encoder" 
                   class="lg-input lg-input--autosadgest"
                   placeholder="Enter encoder name"
                   autocomplete="off" />
          </span>
        </span>
      </div>
      
      <!-- Размер контекстного окна -->
      <div class="row">
        <span class="cluster" title="Размер контекстного окна в токенах">
          <label>Context Limit:</label>
     <input type="number" id="ctxLimit" data-state-key="ctxLimit" 
       class="lg-input lg-input--number"
                 min="1000" max="2000000" step="1000" 
                 placeholder="128000" />
        </span>
      </div>
    </div>

    <div class="block">
      <h3><span class="codicon codicon-tools"></span> Utilities</h3>
      <div class="row">
        <span class="cluster">
          <button class="lg-btn" data-action="createStarter" title="Создать lg-cfg/sections.yaml и примеры .tpl.md/.ctx.md">
             <span class="codicon codicon-new-file"></span><span class="btn-text">Create Starter Config</span>
          </button>
          <button class="lg-btn" data-action="openConfig" title="Открыть lg-cfg/sections.yaml">
           <span class="codicon codicon-file"></span><span class="btn-text">Open Config</span>
          </button>
        </span>
        <span class="cluster">
          <button class="lg-btn" data-action="doctor" title="Проверка окружения и конфигурации">
            <span class="codicon codicon-pulse"></span><span class="btn-text">Doctor</span>
          </button>
          <button class="lg-btn" data-action="resetCache" title="Сбросить кеш Listing Generator">
            <span class="codicon codicon-trash"></span><span class="btn-text">Reset Cache</span>
          </button>
          <button class="lg-btn" data-action="openSettings" title="Открыть настройки расширения">
            <span class="codicon codicon-gear"></span><span class="btn-text">Settings</span>
          </button>
        </span>
      </div>
    </div>
    <script nonce="{{nonce}}" src="{{lgUiJsUri}}"></script>
    <script nonce="{{nonce}}" src="{{controlJsUri}}"></script>
  </body>
</html>
